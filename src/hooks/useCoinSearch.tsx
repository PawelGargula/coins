import { useEffect, useState } from 'react';
import axios, { Canceler } from "axios";
import SearchObject from '../models/search-object';
import Coin from '../models/coin';

const apiKey = "CG-K8zh1ty41yJVzcBkPe7aRiUg";

export default function useCoinSearch(query: string, pageNumber: number) {
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [isError, setIsError] = useState<boolean>(false);
    const [coins, setCoins] = useState<Array<Coin>>([]);
    const [hasMore, setHasMore] = useState<boolean>(false);
    const [notFound, setNotFound] = useState<boolean>(false);

    useEffect(() => {
        setCoins([]);
    }, [query]);

    useEffect(() => {
        let cancelSearch: Canceler;
        let cancelMarkets: Canceler;

        const fetchCoins = async () => {
            try {
                setIsLoading(true);
                setIsError(false);
                setNotFound(false);
                let ids: Array<string> = [];
                if(query) {
                    const response = await axios({
                            method: 'GET',
                            url: "https://api.coingecko.com/api/v3/search",
                            params: {
                                query: query,
                                x_cg_demo_api_key: apiKey
                            },
                            cancelToken: new axios.CancelToken(c => cancelSearch = c)
                        });
                    const foundObject: SearchObject = response.data;
                    const foundCoins = foundObject.coins;
                    ids = foundCoins.map(foundCoin => foundCoin.id);
                }
                
                let coins: Array<Coin> = [];

                if (query && ids.length === 0) {
                    setNotFound(true);
                } else {
                    coins = (await axios({
                        method: 'GET',
                        url: "https://api.coingecko.com/api/v3/coins/markets",
                        params: {
                            vs_currency: "usd",
                            per_page: 5,
                            page: pageNumber,
                            ids: ids.join(),
                            x_cg_demo_api_key: apiKey
                        },
                        cancelToken: new axios.CancelToken(c => cancelMarkets = c)
                    })).data;                    
                }

                // const coins: Array<Coin> = JSON.parse(`[{"id":"bitcoin","symbol":"btc","name":"Bitcoin","image":"https://coin-images.coingecko.com/coins/images/1/large/bitcoin.png?1696501400","current_price":59506,"market_cap":1175252608291,"market_cap_rank":1,"fully_diluted_valuation":1250169997927,"total_volume":13432094066,"high_24h":60334,"low_24h":59104,"price_change_24h":303.31,"price_change_percentage_24h":0.51233,"market_cap_change_24h":6423404854,"market_cap_change_percentage_24h":0.54956,"circulating_supply":19741559.0,"total_supply":21000000.0,"max_supply":21000000.0,"ath":73738,"ath_change_percentage":-19.28697,"ath_date":"2024-03-14T07:10:36.635Z","atl":67.81,"atl_change_percentage":87670.24032,"atl_date":"2013-07-06T00:00:00.000Z","roi":null,"last_updated":"2024-08-18T08:24:44.804Z"},{"id":"ethereum","symbol":"eth","name":"Ethereum","image":"https://coin-images.coingecko.com/coins/images/279/large/ethereum.png?1696501628","current_price":2608.02,"market_cap":313831313877,"market_cap_rank":2,"fully_diluted_valuation":313831313877,"total_volume":5944117774,"high_24h":2639.44,"low_24h":2596.16,"price_change_24h":10.06,"price_change_percentage_24h":0.38721,"market_cap_change_24h":1508402384,"market_cap_change_percentage_24h":0.48296,"circulating_supply":120284052.115992,"total_supply":120284052.115992,"max_supply":null,"ath":4878.26,"ath_change_percentage":-46.53097,"ath_date":"2021-11-10T14:24:19.604Z","atl":0.432979,"atl_change_percentage":602321.7188,"atl_date":"2015-10-20T00:00:00.000Z","roi":{"times":57.5868006015849,"currency":"btc","percentage":5758.68006015849},"last_updated":"2024-08-18T08:24:50.624Z"},{"id":"tether","symbol":"usdt","name":"Tether","image":"https://coin-images.coingecko.com/coins/images/325/large/Tether.png?1696501661","current_price":0.999913,"market_cap":116908241202,"market_cap_rank":3,"fully_diluted_valuation":116908241202,"total_volume":23258481341,"high_24h":1.004,"low_24h":0.998908,"price_change_24h":-0.000130037159370211,"price_change_percentage_24h":-0.013,"market_cap_change_24h":49659584,"market_cap_change_percentage_24h":0.0425,"circulating_supply":116885176708.029,"total_supply":116885176708.029,"max_supply":null,"ath":1.32,"ath_change_percentage":-24.42747,"ath_date":"2018-07-24T00:00:00.000Z","atl":0.572521,"atl_change_percentage":74.64802,"atl_date":"2015-03-02T00:00:00.000Z","roi":null,"last_updated":"2024-08-18T08:24:44.580Z"},{"id":"binancecoin","symbol":"bnb","name":"BNB","image":"https://coin-images.coingecko.com/coins/images/825/large/bnb-icon2_2x.png?1696501970","current_price":538.93,"market_cap":78647568638,"market_cap_rank":4,"fully_diluted_valuation":78647568638,"total_volume":823069886,"high_24h":546.35,"low_24h":522.84,"price_change_24h":16.01,"price_change_percentage_24h":3.06262,"market_cap_change_24h":2394264263,"market_cap_change_percentage_24h":3.13988,"circulating_supply":145887575.79,"total_supply":145887575.79,"max_supply":200000000.0,"ath":717.48,"ath_change_percentage":-24.87488,"ath_date":"2024-06-06T14:10:59.816Z","atl":0.0398177,"atl_change_percentage":1353580.0434,"atl_date":"2017-10-19T00:00:00.000Z","roi":null,"last_updated":"2024-08-18T08:24:27.663Z"},{"id":"solana","symbol":"sol","name":"Solana","image":"https://coin-images.coingecko.com/coins/images/4128/large/solana.png?1718769756","current_price":141.47,"market_cap":65993092625,"market_cap_rank":5,"fully_diluted_valuation":82444764871,"total_volume":1632939653,"high_24h":143.33,"low_24h":138.33,"price_change_24h":2.28,"price_change_percentage_24h":1.63832,"market_cap_change_24h":1145419084,"market_cap_change_percentage_24h":1.76632,"circulating_supply":466323370.462559,"total_supply":582574919.622506,"max_supply":null,"ath":259.96,"ath_change_percentage":-45.56147,"ath_date":"2021-11-06T21:54:35.825Z","atl":0.500801,"atl_change_percentage":28158.32042,"atl_date":"2020-05-11T19:35:23.449Z","roi":null,"last_updated":"2024-08-18T08:24:25.533Z"},{"id":"usd-coin","symbol":"usdc","name":"USDC","image":"https://coin-images.coingecko.com/coins/images/6319/large/usdc.png?1696506694","current_price":0.999793,"market_cap":34819749168,"market_cap_rank":6,"fully_diluted_valuation":34819749679,"total_volume":2297995633,"high_24h":1.005,"low_24h":0.998605,"price_change_24h":2.715e-05,"price_change_percentage_24h":0.00272,"market_cap_change_24h":-12876889.064163208,"market_cap_change_percentage_24h":-0.03697,"circulating_supply":34821772822.2563,"total_supply":34821773332.8664,"max_supply":null,"ath":1.17,"ath_change_percentage":-14.73156,"ath_date":"2019-05-08T00:40:28.300Z","atl":0.877647,"atl_change_percentage":13.93517,"atl_date":"2023-03-11T08:02:13.981Z","roi":null,"last_updated":"2024-08-18T08:24:44.939Z"},{"id":"ripple","symbol":"xrp","name":"XRP","image":"https://coin-images.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png?1696501442","current_price":0.564987,"market_cap":31717762618,"market_cap_rank":7,"fully_diluted_valuation":56517566284,"total_volume":430540071,"high_24h":0.570297,"low_24h":0.562916,"price_change_24h":0.00145118,"price_change_percentage_24h":0.25751,"market_cap_change_24h":100586047,"market_cap_change_percentage_24h":0.31814,"circulating_supply":56113081096.0,"total_supply":99987342059.0,"max_supply":100000000000.0,"ath":3.4,"ath_change_percentage":-83.36891,"ath_date":"2018-01-07T00:00:00.000Z","atl":0.00268621,"atl_change_percentage":20940.79327,"atl_date":"2014-05-22T00:00:00.000Z","roi":null,"last_updated":"2024-08-18T08:24:21.406Z"},{"id":"staked-ether","symbol":"steth","name":"Lido Staked Ether","image":"https://coin-images.coingecko.com/coins/images/13442/large/steth_logo.png?1696513206","current_price":2607.71,"market_cap":25613551644,"market_cap_rank":8,"fully_diluted_valuation":25613551644,"total_volume":27992139,"high_24h":2629.53,"low_24h":2595.96,"price_change_24h":9.83,"price_change_percentage_24h":0.37843,"market_cap_change_24h":98603988,"market_cap_change_percentage_24h":0.38646,"circulating_supply":9819817.66999961,"total_supply":9819817.66999961,"max_supply":null,"ath":4829.57,"ath_change_percentage":-45.99156,"ath_date":"2021-11-10T14:40:47.256Z","atl":482.9,"atl_change_percentage":440.15246,"atl_date":"2020-12-22T04:08:21.854Z","roi":null,"last_updated":"2024-08-18T08:24:14.764Z"},{"id":"the-open-network","symbol":"ton","name":"Toncoin","image":"https://coin-images.coingecko.com/coins/images/17980/large/ton_symbol.png?1696517498","current_price":6.5,"market_cap":16407273059,"market_cap_rank":9,"fully_diluted_valuation":33272617186,"total_volume":237220346,"high_24h":6.54,"low_24h":6.41,"price_change_24h":-0.028377751968912786,"price_change_percentage_24h":-0.43446,"market_cap_change_24h":-44103815.95910072,"market_cap_change_percentage_24h":-0.26809,"circulating_supply":2520138547.35767,"total_supply":5110636291.80613,"max_supply":null,"ath":8.25,"ath_change_percentage":-21.16493,"ath_date":"2024-06-15T00:36:51.509Z","atl":0.519364,"atl_change_percentage":1152.82832,"atl_date":"2021-09-21T00:33:11.092Z","roi":null,"last_updated":"2024-08-18T08:24:28.250Z"},{"id":"dogecoin","symbol":"doge","name":"Dogecoin","image":"https://coin-images.coingecko.com/coins/images/5/large/dogecoin.png?1696501409","current_price":0.102146,"market_cap":14874001425,"market_cap_rank":10,"fully_diluted_valuation":14874889331,"total_volume":336832276,"high_24h":0.103518,"low_24h":0.100804,"price_change_24h":0.00106228,"price_change_percentage_24h":1.05089,"market_cap_change_24h":175078353,"market_cap_change_percentage_24h":1.1911,"circulating_supply":145572836383.705,"total_supply":145581526383.705,"max_supply":null,"ath":0.731578,"ath_change_percentage":-86.03353,"ath_date":"2021-05-08T05:08:23.458Z","atl":8.69e-05,"atl_change_percentage":117473.35774,"atl_date":"2015-05-06T00:00:00.000Z","roi":null,"last_updated":"2024-08-18T08:24:42.373Z"},{"id":"cardano","symbol":"ada","name":"Cardano","image":"https://coin-images.coingecko.com/coins/images/975/large/cardano.png?1696502090","current_price":0.334685,"market_cap":11921751226,"market_cap_rank":11,"fully_diluted_valuation":15060835475,"total_volume":163130591,"high_24h":0.338207,"low_24h":0.329542,"price_change_24h":0.00492377,"price_change_percentage_24h":1.49313,"market_cap_change_24h":181236368,"market_cap_change_percentage_24h":1.54368,"circulating_supply":35620786512.3357,"total_supply":45000000000.0,"max_supply":45000000000.0,"ath":3.09,"ath_change_percentage":-89.15276,"ath_date":"2021-09-02T06:00:10.474Z","atl":0.01925275,"atl_change_percentage":1639.20419,"atl_date":"2020-03-13T02:22:55.044Z","roi":null,"last_updated":"2024-08-18T08:24:23.692Z"},{"id":"tron","symbol":"trx","name":"TRON","image":"https://coin-images.coingecko.com/coins/images/1094/large/tron-logo.png?1696502193","current_price":0.133557,"market_cap":11615862832,"market_cap_rank":12,"fully_diluted_valuation":11615876337,"total_volume":301129732,"high_24h":0.136242,"low_24h":0.133196,"price_change_24h":-0.001422947901097343,"price_change_percentage_24h":-1.0542,"market_cap_change_24h":-119305287.95939445,"market_cap_change_percentage_24h":-1.01665,"circulating_supply":86955142204.3524,"total_supply":86955243301.1473,"max_supply":null,"ath":0.231673,"ath_change_percentage":-42.3649,"ath_date":"2018-01-05T00:00:00.000Z","atl":0.00180434,"atl_change_percentage":7300.19639,"atl_date":"2017-11-12T00:00:00.000Z","roi":{"times":69.29291515755364,"currency":"usd","percentage":6929.291515755363},"last_updated":"2024-08-18T08:24:04.767Z"},{"id":"wrapped-steth","symbol":"wsteth","name":"Wrapped stETH","image":"https://coin-images.coingecko.com/coins/images/18834/large/wstETH.png?1696518295","current_price":3068.03,"market_cap":10707175101,"market_cap_rank":13,"fully_diluted_valuation":10707175101,"total_volume":66164660,"high_24h":3092.44,"low_24h":3052.64,"price_change_24h":15.39,"price_change_percentage_24h":0.50414,"market_cap_change_24h":41583219,"market_cap_change_percentage_24h":0.38988,"circulating_supply":3490873.67761238,"total_supply":3490873.67761238,"max_supply":null,"ath":7256.02,"ath_change_percentage":-57.70621,"ath_date":"2022-05-13T15:09:54.509Z","atl":558.54,"atl_change_percentage":449.4406,"atl_date":"2022-05-13T01:36:45.053Z","roi":null,"last_updated":"2024-08-18T08:24:51.768Z"},{"id":"wrapped-bitcoin","symbol":"wbtc","name":"Wrapped Bitcoin","image":"https://coin-images.coingecko.com/coins/images/7598/large/wrapped_bitcoin_wbtc.png?1696507857","current_price":59448,"market_cap":9167948726,"market_cap_rank":14,"fully_diluted_valuation":9167948726,"total_volume":120069613,"high_24h":60071,"low_24h":59032,"price_change_24h":361.61,"price_change_percentage_24h":0.612,"market_cap_change_24h":43755920,"market_cap_change_percentage_24h":0.47956,"circulating_supply":154151.35641747,"total_supply":154151.35641747,"max_supply":154151.35641747,"ath":73505,"ath_change_percentage":-19.08948,"ath_date":"2024-03-14T07:10:23.403Z","atl":3139.17,"atl_change_percentage":1794.56512,"atl_date":"2019-04-02T00:00:00.000Z","roi":null,"last_updated":"2024-08-18T08:24:48.776Z"},{"id":"avalanche-2","symbol":"avax","name":"Avalanche","image":"https://coin-images.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png?1696512369","current_price":20.72,"market_cap":8196949395,"market_cap_rank":15,"fully_diluted_valuation":9220045396,"total_volume":134920221,"high_24h":20.91,"low_24h":20.41,"price_change_24h":0.217058,"price_change_percentage_24h":1.05864,"market_cap_change_24h":94259057,"market_cap_change_percentage_24h":1.16331,"circulating_supply":395358564.301728,"total_supply":444704942.672531,"max_supply":720000000.0,"ath":144.96,"ath_change_percentage":-85.6978,"ath_date":"2021-11-21T14:18:56.538Z","atl":2.8,"atl_change_percentage":640.17017,"atl_date":"2020-12-31T13:15:21.540Z","roi":null,"last_updated":"2024-08-18T08:24:51.261Z"},{"id":"shiba-inu","symbol":"shib","name":"Shiba Inu","image":"https://coin-images.coingecko.com/coins/images/11939/large/shiba.png?1696511800","current_price":1.332e-05,"market_cap":7849841385,"market_cap_rank":16,"fully_diluted_valuation":13321256109,"total_volume":100412202,"high_24h":1.346e-05,"low_24h":1.323e-05,"price_change_24h":5.6846e-08,"price_change_percentage_24h":0.42851,"market_cap_change_24h":32743246,"market_cap_change_percentage_24h":0.41887,"circulating_supply":589261458305164.9,"total_supply":999982345680531.0,"max_supply":null,"ath":8.616e-05,"ath_change_percentage":-84.53739,"ath_date":"2021-10-28T03:54:55.568Z","atl":5.6366e-11,"atl_change_percentage":23635253.20076,"atl_date":"2020-11-28T11:26:25.838Z","roi":null,"last_updated":"2024-08-18T08:24:41.453Z"},{"id":"weth","symbol":"weth","name":"WETH","image":"https://coin-images.coingecko.com/coins/images/2518/large/weth.png?1696503332","current_price":2608.7,"market_cap":7512381252,"market_cap_rank":17,"fully_diluted_valuation":7512381252,"total_volume":536609089,"high_24h":2632.86,"low_24h":2596.21,"price_change_24h":11.74,"price_change_percentage_24h":0.45194,"market_cap_change_24h":43185479,"market_cap_change_percentage_24h":0.57818,"circulating_supply":2878734.01511684,"total_supply":2878734.01511684,"max_supply":null,"ath":4799.89,"ath_change_percentage":-45.65203,"ath_date":"2021-11-09T00:00:00.000Z","atl":82.1,"atl_change_percentage":3077.26685,"atl_date":"2018-12-15T00:00:00.000Z","roi":null,"last_updated":"2024-08-18T08:24:34.507Z"},{"id":"bitcoin-cash","symbol":"bch","name":"Bitcoin Cash","image":"https://coin-images.coingecko.com/coins/images/780/large/bitcoin-cash-circle.png?1696501932","current_price":340.2,"market_cap":6725184623,"market_cap_rank":18,"fully_diluted_valuation":7151393900,"total_volume":140397780,"high_24h":347.39,"low_24h":339.69,"price_change_24h":-0.161333354224098,"price_change_percentage_24h":-0.0474,"market_cap_change_24h":4767985,"market_cap_change_percentage_24h":0.07095,"circulating_supply":19748440.5216508,"total_supply":21000000.0,"max_supply":21000000.0,"ath":3785.82,"ath_change_percentage":-91.00545,"ath_date":"2017-12-20T00:00:00.000Z","atl":76.93,"atl_change_percentage":342.60517,"atl_date":"2018-12-16T00:00:00.000Z","roi":null,"last_updated":"2024-08-18T08:24:52.491Z"},{"id":"chainlink","symbol":"link","name":"Chainlink","image":"https://coin-images.coingecko.com/coins/images/877/large/chainlink-new-logo.png?1696502009","current_price":10.08,"market_cap":6132321401,"market_cap_rank":19,"fully_diluted_valuation":10084396793,"total_volume":135607116,"high_24h":10.22,"low_24h":10.04,"price_change_24h":0.01436652,"price_change_percentage_24h":0.14267,"market_cap_change_24h":11376207,"market_cap_change_percentage_24h":0.18586,"circulating_supply":608099971.3083414,"total_supply":1000000000.0,"max_supply":1000000000.0,"ath":52.7,"ath_change_percentage":-80.86297,"ath_date":"2021-05-10T00:13:57.214Z","atl":0.148183,"atl_change_percentage":6705.47007,"atl_date":"2017-11-29T00:00:00.000Z","roi":null,"last_updated":"2024-08-18T08:24:17.446Z"},{"id":"polkadot","symbol":"dot","name":"Polkadot","image":"https://coin-images.coingecko.com/coins/images/12171/large/polkadot.png?1696512008","current_price":4.37,"market_cap":6122589330,"market_cap_rank":20,"fully_diluted_valuation":6476198770,"total_volume":78966787,"high_24h":4.39,"low_24h":4.3,"price_change_24h":0.059951,"price_change_percentage_24h":1.39217,"market_cap_change_24h":89890678,"market_cap_change_percentage_24h":1.49006,"circulating_supply":1401312835.34699,"total_supply":1482245496.40078,"max_supply":null,"ath":54.98,"ath_change_percentage":-92.05266,"ath_date":"2021-11-04T14:10:09.301Z","atl":2.7,"atl_change_percentage":61.98672,"atl_date":"2020-08-20T05:48:11.359Z","roi":null,"last_updated":"2024-08-18T08:24:17.086Z"}]`);
                setCoins(prevCoins => [...prevCoins, ...coins]);
                
                setHasMore(coins.length > 0);
            } catch (error) {
                if (axios.isCancel(error)) return;
                
                setIsError(true);
                console.error(error);
            } finally {
                setIsLoading(false);
            }
        };
  
        fetchCoins();

        return () => {
            if (cancelSearch) {
                cancelSearch();
            }
            if (cancelMarkets) {
                cancelMarkets();      
            }
        };
    }, [query, pageNumber])

    return { isLoading, isError, coins, hasMore, notFound };
}